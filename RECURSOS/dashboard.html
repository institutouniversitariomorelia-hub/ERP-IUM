<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP IUM - Sistema de Control (Local)</title>
    <link rel="icon" href="logo ium blanco.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <style>
        :root { --bs-danger: #E70000; }
        body { background-color: #f8f9fa; }
        #sidebar { width: 250px; height: 100vh; position: fixed; background-color: var(--bs-danger); padding: 0; z-index: 1000; box-shadow: 2px 0 5px rgba(0,0,0,.3); }
        #sidebar .logo-container img { max-height: 60px; }
        #sidebar .nav-link { color: white; padding: 15px; border-left: 5px solid transparent; transition: all 0.2s; }
        #sidebar .nav-link:hover { background-color: #b80000; color: white; }
        #sidebar .nav-link.active { background-color: #b80000; border-left: 5px solid white; color: white; font-weight: bold; }
        #main-content { margin-left: 250px; padding: 0; width: calc(100% - 250px); }
        .top-header { background-color: #fff; color: #343a40; padding: 10px 20px; box-shadow: 0 2px 4px rgba(0,0,0,.05); font-size: 1.2rem; font-weight: bold; border-bottom: 5px solid #ccc; position: sticky; top: 0; z-index: 999; display: flex; align-items: center; }
        .action-menu { background-color: white; padding: 10px 20px; border-bottom: 1px solid #dee2e6; position: sticky; top: 60px; z-index: 998; }
        .action-menu .btn { border-radius: 0; border-bottom: 3px solid transparent; font-size: 0.9rem; transition: all 0.2s; }
        .action-menu .btn.active { border-bottom: 3px solid var(--bs-danger); color: var(--bs-danger); background-color: #f8f9fa; }
        .modal-header-danger { background-color: var(--bs-danger); color: white; }
        .small-muted { font-size: .9rem; color:#6c757d; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="p-3 text-center border-bottom border-secondary mb-3 logo-container">
            <img src="logo ium blanco.png" alt="Logo IUM Blanco" class="img-fluid">
            <p class="text-white small mt-2">Navegación Principal</p>
        </div>
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link active" href="#" data-module="mi-perfil"><ion-icon name="person-circle-outline" class="me-2"></ion-icon> Mi Perfil</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-module="egresos"><ion-icon name="trending-down-outline" class="me-2"></ion-icon> Egresos</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-module="ingresos"><ion-icon name="trending-up-outline" class="me-2"></ion-icon> Ingresos</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-module="categorias"><ion-icon name="pricetags-outline" class="me-2"></ion-icon> Categorías</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-module="presupuestos"><ion-icon name="wallet-outline" class="me-2"></ion-icon> Presupuestos</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-module="auditoria"><ion-icon name="layers-outline" class="me-2"></ion-icon> Historial Auditoría</a></li>
            <li class="nav-item mt-5"><a id="logoutLink" class="nav-link" href="#"><ion-icon name="log-out-outline" class="me-2"></ion-icon> Cerrar Sesión</a></li>
        </ul>
    </div>

    <div id="main-content">
        <header class="top-header">SISTEMA DE CONTROL DE EGRESOS Y INGRESOS IUM</header>
        <nav id="action-menu-container" class="action-menu"></nav>
        <div id="view-container" class="p-4"></div>
    </div>

    <!-- Modales (ajustados / nuevos) -->
    <!-- Registro SU (ahora funcional y guarda usuarios localmente) -->
    <div class="modal fade" id="modalAgregarUsuario" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header modal-header-danger">
                    <h5 class="modal-title">Registrar Nuevo Usuario</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formRegistrarUsuario">
                        <div class="mb-3"><label class="form-label">Nombre</label><input id="new_user_nombre" type="text" class="form-control" required></div>
                        <div class="mb-3"><label class="form-label">Usuario (username)</label><input id="new_user_usuario" type="text" class="form-control" required></div>
                        <div class="mb-3"><label class="form-label">Contraseña Inicial</label><input id="new_user_password" type="password" class="form-control" required></div>
                        <div class="mb-3">
                            <label class="form-label">Asignar Rol</label>
                            <select id="new_user_rol" class="form-select" required>
                                <option value="ADM">Administración (ADM)</option>
                                <option value="COB">Cobranzas (COB)</option>
                                <option value="REC">Rectoría (REC)</option>
                                <option value="SU">SUPER USUARIO (SU)</option>
                            </select>
                        </div>
                        <div id="usuarioAlert" class="alert alert-danger d-none"></div>
                        <button type="submit" class="btn btn-danger">Registrar Usuario</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Cambio de contraseña -->
    <div class="modal fade" id="modalCambiarPassword" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header modal-header-danger">
                    <h5 class="modal-title">Cambiar Contraseña</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formCambiarPassword">
                        <input type="hidden" id="change_user_username">
                        <div class="mb-3"><label class="form-label">Nueva Contraseña</label><input id="change_user_password" type="password" class="form-control" required></div>
                        <div id="passAlert" class="alert alert-danger d-none"></div>
                        <button type="submit" class="btn btn-danger">Guardar Contraseña</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Egreso / Ingreso / Categoria / Presupuesto modals remain for adding and editing (we'll reuse single generic modals) -->
    <div class="modal fade" id="modalAgregarEgreso" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header modal-header-danger">
                    <h5 class="modal-title">Registrar Nuevo Egreso</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formEgreso">
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">Folio</label><input id="eg_folio" type="text" class="form-control" placeholder="Ej: FCT-00123" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Fecha</label><input id="eg_fecha" type="date" class="form-control" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Monto</label><input id="eg_monto" type="number" class="form-control" min="1" placeholder="Ej: 5000.00" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Categoría</label><select id="eg_categoria" class="form-select"></select></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Proveedor</label><input id="eg_proveedor" type="text" class="form-control" placeholder="Ej: CFE" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Forma de Pago</label><select id="eg_pago" class="form-select"><option>Transferencia</option><option>Efectivo</option></select></div>
                            <div class="col-md-12 mb-3"><label class="form-label">Descripción</label><textarea id="eg_descripcion" class="form-control" rows="2"></textarea></div>
                        </div>
                        <div id="egresoAlert" class="alert alert-danger d-none"></div>
                        <input type="hidden" id="eg_edit_index">
                        <button type="submit" class="btn btn-danger mt-3">Guardar Egreso</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalAgregarIngreso" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header modal-header-danger">
                    <h5 class="modal-title">Registrar Nuevo Ingreso</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formIngreso">
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">Folio</label><input id="in_folio" type="text" class="form-control" placeholder="Ej: PAGO-0050" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Fecha de Pago</label><input id="in_fecha" type="date" class="form-control" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Monto</label><input id="in_monto" type="number" class="form-control" min="1" placeholder="Ej: 5000.00" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Categoría</label><select id="in_categoria" class="form-select"></select></div>
                            <div class="col-md-12 mb-3"><label class="form-label">Alumno/Referencia</label><input id="in_ref" type="text" class="form-control" placeholder="Nombre del alumno o referencia de pago" required></div>
                            <div class="col-md-4 mb-3"><label class="form-label">Mes Correspondiente</label><input id="in_mes" type="text" class="form-control" placeholder="Ej: Octubre 2025"></div>
                            <div class="col-md-4 mb-3"><label class="form-label">Matrícula</label><input id="in_matricula" type="text" class="form-control"></div>
                        </div>
                        <div id="ingresoAlert" class="alert alert-danger d-none"></div>
                        <input type="hidden" id="in_edit_index">
                        <button type="submit" class="btn btn-danger mt-3">Guardar Ingreso</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalAgregarCategoria" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header modal-header-danger">
                    <h5 class="modal-title">Agregar / Editar Categoría</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formCategoria">
                        <div class="mb-3"><label class="form-label">Nombre de Categoría</label><input id="cat_nombre" type="text" class="form-control" required></div>
                        <div class="mb-3">
                            <label class="form-label">Tipo de Flujo</label>
                            <select id="cat_tipo" class="form-select" required>
                                <option value="Ingreso">Ingreso</option>
                                <option value="Egreso">Egreso</option>
                            </select>
                        </div>
                        <div class="mb-3"><label class="form-label">Descripción</label><textarea id="cat_desc" class="form-control" rows="2"></textarea></div>
                        <div id="categoriaAlert" class="alert alert-danger d-none"></div>
                        <input type="hidden" id="cat_edit_index">
                        <button type="submit" class="btn btn-danger">Guardar Categoría</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalAgregarPresupuesto" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header modal-header-danger">
                    <h5 class="modal-title">Asignar/Actualizar Presupuesto</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formPresupuesto">
                        <div class="mb-3">
                            <label class="form-label">Categoría</label>
                            <select id="pres_categoria" class="form-select" required></select>
                        </div>
                        <div class="mb-3"><label class="form-label">Monto Límite</label><input id="pres_monto" type="number" class="form-control" min="1" placeholder="Ej: 150000.00" required></div>
                        <div class="mb-3"><label class="form-label">Fecha de Asignación</label><input id="pres_fecha" type="date" class="form-control" required></div>
                        <div id="presupuestoAlert" class="alert alert-danger d-none"></div>
                        <input type="hidden" id="pres_edit_index">
                        <button type="submit" class="btn btn-danger">Guardar/Actualizar Presupuesto</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Reporte (Generación) -->
    <div class="modal fade" id="modalReporte" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header modal-header-danger">
                    <h5 class="modal-title">Generar Reporte</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formReporte">
                        <div class="mb-3"><label class="form-label">Sección</label>
                            <select id="rep_seccion" class="form-select">
                                <option value="">Todas</option>
                                <option value="Egreso">Egreso</option>
                                <option value="Ingreso">Ingreso</option>
                                <option value="Categoria">Categoria</option>
                                <option value="Presupuesto">Presupuesto</option>
                            </select>
                        </div>
                        <div class="mb-3"><label class="form-label">Categoría (opcional)</label><select id="rep_categoria" class="form-select"><option value="">Todas</option></select></div>
                        <div class="mb-3 d-flex"><input id="rep_fecha_inicio" type="date" class="form-control me-2"><input id="rep_fecha_fin" type="date" class="form-control"></div>
                        <div class="mb-3"><label class="form-label">Usuario</label><select id="rep_usuario" class="form-select"><option value="">Todos</option></select></div>
                        <button type="submit" class="btn btn-danger">Generar y Descargar CSV</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    /* ========================
       Local storage helper + initial seed
       ======================== */
    const STORAGE_KEYS = {
        users: 'ium_users_v1',
        currentUser: 'ium_current_user_v1',
        egresos: 'ium_egresos_v1',
        ingresos: 'ium_ingresos_v1',
        categorias: 'ium_categorias_v1',
        presupuestos: 'ium_presupuestos_v1',
        auditoria: 'ium_auditoria_v1'
    };

    function read(key) { try { return JSON.parse(localStorage.getItem(key) || 'null'); } catch { return null; } }
    function write(key, val) { localStorage.setItem(key, JSON.stringify(val)); }

    // seed basic data if empty
    if (!read(STORAGE_KEYS.users)) {
        write(STORAGE_KEYS.users, [
            { nombre: 'Super Admin', username: 'su_admin', password: 'admin123', rol: 'SU' },
            { nombre: 'Administración', username: 'admin1', password: 'adm123', rol: 'ADM' }
        ]);
    }
    if (!read(STORAGE_KEYS.categorias)) {
        write(STORAGE_KEYS.categorias, [
            { nombre: 'Colegiaturas', tipo: 'Ingreso', descripcion: '' },
            { nombre: 'Nómina', tipo: 'Egreso', descripcion: '' },
            { nombre: 'Servicios Básicos', tipo: 'Egreso', descripcion: '' }
        ]);
    }
    if (!read(STORAGE_KEYS.egresos)) write(STORAGE_KEYS.egresos, []);
    if (!read(STORAGE_KEYS.ingresos)) write(STORAGE_KEYS.ingresos, []);
    if (!read(STORAGE_KEYS.presupuestos)) write(STORAGE_KEYS.presupuestos, []);
    if (!read(STORAGE_KEYS.auditoria)) write(STORAGE_KEYS.auditoria, []);

    // Simula usuario conectado (si no hay currentUser, usar el primer usuario)
    if (!read(STORAGE_KEYS.currentUser)) {
        const users = read(STORAGE_KEYS.users);
        write(STORAGE_KEYS.currentUser, users[0]);
    }

    /* ========================
       Helpers
       ======================== */
    function addAudit({ usuario, seccion, accion, detalles }) {
        const audits = read(STORAGE_KEYS.auditoria) || [];
        audits.unshift({ fecha: new Date().toISOString(), usuario, seccion, accion, detalles });
        write(STORAGE_KEYS.auditoria, audits);
    }

    function getCurrentUser() { return read(STORAGE_KEYS.currentUser); }

    function refreshCategorySelects() {
        const cats = read(STORAGE_KEYS.categorias) || [];
        const $eg = $('#eg_categoria'); const $in = $('#in_categoria'); const $pres = $('#pres_categoria'); const $rep_cat = $('#rep_categoria');
        [$eg, $in, $pres, $rep_cat].forEach($sel => {
            $sel.empty();
            if ($sel.is('#rep_categoria')) $sel.append('<option value="">Todas</option>');
            cats.forEach(c => $sel.append(`<option value="${c.nombre}">${c.nombre} (${c.tipo})</option>`));
        });
    }

    function refreshUserOptions() {
        const users = read(STORAGE_KEYS.users) || [];
        const $rep_user = $('#rep_usuario'); $rep_user.empty(); $rep_user.append('<option value="">Todos</option>');
        users.forEach(u => $rep_user.append(`<option value="${u.username}">${u.nombre} (${u.username})</option>`));
    }

    /* ========================
       Views content and loaders
       ======================== */
    function renderMiPerfil() {
        const cu = getCurrentUser();
        const users = read(STORAGE_KEYS.users) || [];
        const html = `
            <h2 class="mb-4 text-danger">Mi Perfil</h2>
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-danger text-white">Datos de Acceso</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label fw-bold">Nombre</label><p class="form-control-plaintext">${cu.nombre}</p></div>
                        <div class="col-md-6 mb-3"><label class="form-label fw-bold">Rol</label><p class="form-control-plaintext text-danger fw-bold">${cu.rol}</p></div>
                    </div>
                    <button id="btnCambiarMiPass" class="btn btn-outline-secondary btn-sm me-3">Cambiar mi contraseña</button>
                    <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalAgregarUsuario">Registrar Usuario (SU)</button>
                </div>
            </div>

            <h4 class="text-danger">Usuarios registrados</h4>
            <div class="card shadow-sm"><div class="card-body p-0">
                <table class="table mb-0">
                    <thead><tr><th>Nombre</th><th>Usuario</th><th>Rol</th><th>Acciones</th></tr></thead>
                    <tbody id="tablaUsuarios"></tbody>
                </table>
            </div></div>
        `;
        $('#view-container').html(html);
        renderUsuariosTable();
    }

    function renderUsuariosTable() {
        const users = read(STORAGE_KEYS.users) || [];
        const cu = getCurrentUser();
        const $t = $('#tablaUsuarios'); $t.empty();
        users.forEach((u, idx) => {
            $t.append(`<tr>
                <td>${u.nombre}</td>
                <td>${u.username}</td>
                <td>${u.rol}</td>
                <td>
                    <button class="btn btn-sm btn-warning btn-edit-user" data-idx="${idx}">Editar</button>
                    <button class="btn btn-sm btn-secondary btn-change-pass" data-username="${u.username}">Cambiar Contraseña</button>
                    ${u.username !== cu.username ? `<button class="btn btn-sm btn-danger btn-delete-user" data-username="${u.username}">Eliminar</button>` : ''}
                </td>
            </tr>`);
        });
    }

    function renderEgresosView() {
        const egresos = read(STORAGE_KEYS.egresos) || [];
        const html = `
            <h2 class="mb-4 text-danger">Egresos: Historial Reciente</h2>
            <div class="mb-3"><button class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#modalAgregarEgreso" id="btnNuevoEgreso">Agregar Egreso</button></div>
            <div class="card"><div class="card-body"><table class="table"><thead><tr><th>Fecha</th><th>Folio</th><th>Proveedor</th><th>Categoría</th><th>Monto</th><th>Acciones</th></tr></thead><tbody id="tablaEgresos"></tbody></table></div></div>
        `;
        $('#view-container').html(html);
        renderEgresosTable();
    }
    function renderEgresosTable() {
        const egresos = read(STORAGE_KEYS.egresos) || [];
        const $t = $('#tablaEgresos'); $t.empty();
        egresos.forEach((e, idx) => {
            $t.append(`<tr>
                <td>${e.fecha}</td><td>${e.folio}</td><td>${e.proveedor}</td><td>${e.categoria}</td><td class="text-danger">$ ${Number(e.monto).toFixed(2)}</td>
                <td><button class="btn btn-sm btn-warning btn-edit-eg" data-idx="${idx}">Editar</button> <button class="btn btn-sm btn-danger btn-del-eg" data-idx="${idx}">Eliminar</button></td>
            </tr>`);
        });
    }

    function renderIngresosView() {
        const html = `
            <h2 class="mb-4 text-danger">Ingresos: Historial Reciente</h2>
            <div class="mb-3"><button class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#modalAgregarIngreso" id="btnNuevoIngreso">Agregar Ingreso</button></div>
            <div class="card"><div class="card-body"><table class="table"><thead><tr><th>Fecha</th><th>Folio</th><th>Referencia</th><th>Categoría</th><th>Monto</th><th>Acciones</th></tr></thead><tbody id="tablaIngresos"></tbody></table></div></div>
        `;
        $('#view-container').html(html);
        renderIngresosTable();
    }
    function renderIngresosTable() {
        const items = read(STORAGE_KEYS.ingresos) || [];
        const $t = $('#tablaIngresos'); $t.empty();
        items.forEach((i, idx) => {
            $t.append(`<tr>
                <td>${i.fecha}</td><td>${i.folio}</td><td>${i.ref}</td><td>${i.categoria}</td><td class="text-success">$ ${Number(i.monto).toFixed(2)}</td>
                <td><button class="btn btn-sm btn-warning btn-edit-in" data-idx="${idx}">Editar</button> <button class="btn btn-sm btn-danger btn-del-in" data-idx="${idx}">Eliminar</button></td>
            </tr>`);
        });
    }

    function renderCategoriasView() {
        const html = `
            <h2 class="mb-4 text-danger">Categorías: Catálogo Actual</h2>
            <div class="mb-3"><button class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#modalAgregarCategoria">Agregar Categoría</button> <button id="btnRefrescarCats" class="btn btn-outline-secondary btn-sm">Refrescar</button></div>
            <div class="card"><div class="card-body"><table class="table"><thead><tr><th>ID</th><th>Nombre</th><th>Tipo</th><th>Descripción</th><th>Acciones</th></tr></thead><tbody id="tablaCategorias"></tbody></table></div></div>
        `;
        $('#view-container').html(html);
        renderCategoriasTable();
    }
    function renderCategoriasTable() {
        const cats = read(STORAGE_KEYS.categorias) || [];
        const $t = $('#tablaCategorias'); $t.empty();
        cats.forEach((c, idx) => {
            $t.append(`<tr>
                <td>${idx+1}</td><td>${c.nombre}</td><td>${c.tipo}</td><td>${c.descripcion}</td>
                <td>
                    <button class="btn btn-sm btn-warning btn-edit-cat" data-idx="${idx}">Editar</button>
                    <button class="btn btn-sm btn-danger btn-del-cat" data-idx="${idx}">Eliminar</button>
                </td>
            </tr>`);
        });
    }

    function renderPresupuestosView() {
        const pres = read(STORAGE_KEYS.presupuestos) || [];
        const html = `
            <h2 class="mb-4 text-danger">Presupuestos: Resumen General</h2>
            <div class="mb-3"><button class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#modalAgregarPresupuesto">Agregar/Actualizar Presupuesto</button></div>
            <div class="card"><div class="card-body"><table class="table"><thead><tr><th>Categoria</th><th>Monto</th><th>Fecha Asig.</th><th>Acciones</th></tr></thead><tbody id="tablaPresupuestos"></tbody></table></div></div>
        `;
        $('#view-container').html(html);
        renderPresupuestosTable();
    }
    function renderPresupuestosTable() {
        const pres = read(STORAGE_KEYS.presupuestos) || [];
        const $t = $('#tablaPresupuestos'); $t.empty();
        pres.forEach((p, idx) => {
            $t.append(`<tr><td>${p.categoria}</td><td>$ ${Number(p.monto).toFixed(2)}</td><td>${p.fecha}</td><td><button class="btn btn-sm btn-warning btn-edit-pres" data-idx="${idx}">Editar</button> <button class="btn btn-sm btn-danger btn-del-pres" data-idx="${idx}">Eliminar</button></td></tr>`);
        });
    }

    function renderAuditoriaView() {
        const html = `
            <h2 class="mb-4 text-danger">Historial de Auditoría</h2>
            <div class="card mb-3"><div class="card-body">
                <form id="formFiltrosAuditoria" class="row g-2 align-items-center">
                    <div class="col-md-3"><label class="form-label small-muted">Sección</label><select id="f_seccion" class="form-select"><option value="">Todas</option><option value="Egreso">Egreso</option><option value="Ingreso">Ingreso</option><option value="Categoria">Categoria</option><option value="Presupuesto">Presupuesto</option></select></div>
                    <div class="col-md-3"><label class="form-label small-muted">Usuario</label><select id="f_usuario" class="form-select"><option value="">Todos</option></select></div>
                    <div class="col-md-4 d-flex"><label class="form-label small-muted">Rango</label><input id="f_inicio" type="date" class="form-control me-2"><input id="f_fin" type="date" class="form-control"></div>
                    <div class="col-md-2"><button type="submit" class="btn btn-danger w-100">Filtrar</button></div>
                </form>
            </div></div>
            <div class="card"><div class="card-body"><h5>Historial Global</h5><div class="table-responsive"><table class="table table-striped"><thead><tr><th>Fecha</th><th>Usuario</th><th>Sección</th><th>Acción</th><th>Detalles</th></tr></thead><tbody id="tablaAuditoria"></tbody></table></div></div></div>
            <div class="card mt-3"><div class="card-body"><h5>Historial de Cambios (solo actualizaciones)</h5><table class="table"><thead><tr><th>Fecha</th><th>Usuario</th><th>Sección</th><th>Detalles</th></tr></thead><tbody id="tablaCambios"></tbody></table></div></div>
            <div class="mt-3"><button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalReporte">Generar Reporte</button></div>
        `;
        $('#view-container').html(html);
        refreshCategorySelects(); refreshUserOptions();
        renderAuditoriaTables();
    }
    function renderAuditoriaTables(filter) {
        const audits = read(STORAGE_KEYS.auditoria) || [];
        const $t = $('#tablaAuditoria'); $t.empty();
        const $c = $('#tablaCambios'); $c.empty();
        const f = filter || {};
        const filtered = audits.filter(a => {
            if (f.seccion && a.seccion !== f.seccion) return false;
            if (f.usuario && a.usuario !== f.usuario) return false;
            if (f.inicio && new Date(a.fecha) < new Date(f.inicio)) return false;
            if (f.fin && new Date(a.fecha) > new Date(f.fin)) return false;
            return true;
        });
        filtered.forEach(a => {
            $t.append(`<tr><td>${new Date(a.fecha).toLocaleString()}</td><td>${a.usuario}</td><td>${a.seccion}</td><td>${a.accion}</td><td>${a.detalles}</td></tr>`);
            if (a.accion.toLowerCase().includes('actualiz')) {
                $c.append(`<tr><td>${new Date(a.fecha).toLocaleString()}</td><td>${a.usuario}</td><td>${a.seccion}</td><td>${a.detalles}</td></tr>`);
            }
        });
    }

    /* ========================
       Navigation and action menus
       ======================== */
    const actionMenus = {
        'egresos': `<button class="btn btn-sm btn-light text-secondary me-3 active" data-action="historial-egresos">Historial</button><button class="btn btn-sm btn-light text-secondary me-3" data-bs-toggle="modal" data-bs-target="#modalAgregarEgreso">Agregar Egreso</button><button class="btn btn-sm btn-light text-secondary me-3" data-action="reportes-egresos">Reportes</button>`,
        'ingresos': `<button class="btn btn-sm btn-light text-secondary me-3 active" data-action="historial-ingresos">Historial</button><button class="btn btn-sm btn-light text-secondary me-3" data-bs-toggle="modal" data-bs-target="#modalAgregarIngreso">Agregar Ingreso</button><button class="btn btn-sm btn-light text-secondary me-3" data-action="reportes-ingresos">Reportes</button>`,
        'categorias': `<button class="btn btn-sm btn-light text-secondary me-3 active" data-action="vista-categorias">Ver Categorías</button><button class="btn btn-sm btn-light text-secondary me-3" data-bs-toggle="modal" data-bs-target="#modalAgregarCategoria">Agregar Categoría</button><button class="btn btn-sm btn-light text-secondary me-3" data-action="eliminar-categoria">Eliminar</button>`,
        'presupuestos': `<button class="btn btn-sm btn-light text-secondary me-3 active" data-action="vista-presupuestos">Ver Presupuesto</button><button class="btn btn-sm btn-light text-secondary me-3" data-bs-toggle="modal" data-bs-target="#modalAgregarPresupuesto">Agregar</button><button class="btn btn-sm btn-light text-secondary me-3" data-action="actualizar-presupuesto">Actualizar</button>`,
        'auditoria': `<button class="btn btn-sm btn-light text-secondary me-3 active" data-action="historial-global">Historial Global</button><button class="btn btn-sm btn-light text-secondary me-3" data-action="historial-cambios">Historial de Cambios</button><button class="btn btn-sm btn-light text-secondary me-3" data-action="generar-reporte-auditoria">Generar Reporte</button>`,
        'mi-perfil': ''
    };

    const views = { 'mi-perfil': renderMiPerfil, 'egresos': renderEgresosView, 'ingresos': renderIngresosView, 'categorias': renderCategoriasView, 'presupuestos': renderPresupuestosView, 'auditoria': renderAuditoriaView };

    function loadModule(moduleName) {
        $('#sidebar .nav-link').removeClass('active');
        $('#sidebar .nav-link[data-module="' + moduleName + '"]').addClass('active');
        $('#action-menu-container').html(actionMenus[moduleName] || '');
        const render = views[moduleName];
        if (render) render(); else $('#view-container').html('<h2>Módulo en construcción.</h2>');
    }

    /* ========================
       Events: forms and CRUD
       ======================== */
    
    // Registrar usuario
    $(document).on('submit', '#formRegistrarUsuario', function(e){
        e.preventDefault();
        const nombre = $('#new_user_nombre').val().trim();
        const username = $('#new_user_usuario').val().trim();
        const password = $('#new_user_password').val();
        const rol = $('#new_user_rol').val();
        const users = read(STORAGE_KEYS.users) || [];
        if (users.find(u => u.username === username)) {
            $('#usuarioAlert').text('Usuario ya existe').removeClass('d-none'); return;
        }
        users.push({ nombre, username, password, rol });
        write(STORAGE_KEYS.users, users);
        addAudit({ usuario: getCurrentUser().username, seccion: 'Usuario', accion: 'Creación', detalles: `Usuario ${username} creado` });
        $('#modalAgregarUsuario').modal('hide');
        $('#formRegistrarUsuario')[0].reset();
        if ($('#view-container').find('#tablaUsuarios').length) renderUsuariosTable();
        refreshUserOptions();
    });

    // Cambiar contraseña
    $(document).on('click', '.btn-change-pass', function(){
        const username = $(this).data('username');
        $('#change_user_username').val(username);
        $('#change_user_password').val('');
        $('#modalCambiarPassword').modal('show');
    });
    $(document).on('click', '#btnCambiarMiPass', function(){
        const cu = getCurrentUser(); $('#change_user_username').val(cu.username); $('#change_user_password').val(''); $('#modalCambiarPassword').modal('show');
    });
    $(document).on('submit', '#formCambiarPassword', function(e){
        e.preventDefault();
        const username = $('#change_user_username').val();
        const npass = $('#change_user_password').val();
        const users = read(STORAGE_KEYS.users) || [];
        const u = users.find(x => x.username === username);
        if (!u) { $('#passAlert').text('Usuario no encontrado').removeClass('d-none'); return; }
        u.password = npass; write(STORAGE_KEYS.users, users);
        addAudit({ usuario: getCurrentUser().username, seccion: 'Usuario', accion: 'Actualización', detalles: `Contraseña cambiada para ${username}` });
        $('#modalCambiarPassword').modal('hide');
        if ($('#view-container').find('#tablaUsuarios').length) renderUsuariosTable();
    });

    // Eliminar usuario
    $(document).on('click', '.btn-delete-user', function(){
        const username = $(this).data('username');
        if (!confirm('¿Eliminar usuario '+username+'?')) return;
        let users = read(STORAGE_KEYS.users) || [];
        users = users.filter(u => u.username !== username);
        write(STORAGE_KEYS.users, users);
        addAudit({ usuario: getCurrentUser().username, seccion: 'Usuario', accion: 'Eliminación', detalles: `Usuario ${username} eliminado` });
        renderUsuariosTable(); refreshUserOptions();
    });

    // Editar usuario (sencillo: abrir modal con datos y overwrite)
    $(document).on('click', '.btn-edit-user', function(){
        const idx = $(this).data('idx');
        const users = read(STORAGE_KEYS.users) || [];
        const u = users[idx];
        $('#new_user_nombre').val(u.nombre); $('#new_user_usuario').val(u.username).prop('disabled', true); $('#new_user_password').val(u.password); $('#new_user_rol').val(u.rol);
        $('#cat_edit_index').val(''); // reuse safety
        $('#modalAgregarUsuario').modal('show');
        // on save overwrite existing
        $('#formRegistrarUsuario').off('submit.update').on('submit.update', function(ev){
            ev.preventDefault();
            u.nombre = $('#new_user_nombre').val().trim();
            u.password = $('#new_user_password').val();
            u.rol = $('#new_user_rol').val();
            write(STORAGE_KEYS.users, users);
            addAudit({ usuario: getCurrentUser().username, seccion: 'Usuario', accion: 'Actualización', detalles: `Usuario ${u.username} actualizado` });
            $('#modalAgregarUsuario').modal('hide');
            $('#formRegistrarUsuario')[0].reset(); $('#new_user_usuario').prop('disabled', false);
            renderUsuariosTable(); refreshUserOptions();
            // unbind this update handler and rebind original
            setTimeout(()=>{ $('#formRegistrarUsuario').off('submit.update'); }, 10);
        });
    });

    /* ------- Egresos CRUD ------- */
    $('#formEgreso').on('submit', function(e){
        e.preventDefault();
        const list = read(STORAGE_KEYS.egresos) || [];
        const data = { folio: $('#eg_folio').val(), fecha: $('#eg_fecha').val(), monto: $('#eg_monto').val(), categoria: $('#eg_categoria').val(), proveedor: $('#eg_proveedor').val(), descripcion: $('#eg_descripcion').val() };
        const editIndex = $('#eg_edit_index').val();
        if (editIndex) {
            list[editIndex] = data; write(STORAGE_KEYS.egresos, list);
            addAudit({ usuario: getCurrentUser().username, seccion: 'Egreso', accion: 'Actualización', detalles: `Egreso ${data.folio} actualizado` });
        } else {
            list.unshift(data); write(STORAGE_KEYS.egresos, list);
            addAudit({ usuario: getCurrentUser().username, seccion: 'Egreso', accion: 'Creación', detalles: `Egreso ${data.folio} creado` });
        }
        $('#modalAgregarEgreso').modal('hide'); $('#formEgreso')[0].reset(); $('#eg_edit_index').val(''); renderEgresosTable();
    });
    $(document).on('click', '.btn-edit-eg', function(){ const idx = $(this).data('idx'); const list = read(STORAGE_KEYS.egresos)||[]; const e = list[idx]; $('#eg_folio').val(e.folio); $('#eg_fecha').val(e.fecha); $('#eg_monto').val(e.monto); $('#eg_categoria').val(e.categoria); $('#eg_proveedor').val(e.proveedor); $('#eg_descripcion').val(e.descripcion); $('#eg_edit_index').val(idx); $('#modalAgregarEgreso').modal('show'); });
    $(document).on('click', '.btn-del-eg', function(){ const idx = $(this).data('idx'); if(!confirm('Eliminar egreso?')) return; let list = read(STORAGE_KEYS.egresos)||[]; const removed = list.splice(idx,1); write(STORAGE_KEYS.egresos, list); addAudit({ usuario: getCurrentUser().username, seccion: 'Egreso', accion: 'Eliminación', detalles: `Egreso ${removed[0].folio} eliminado` }); renderEgresosTable(); });

    /* ------- Ingresos CRUD ------- */
    $('#formIngreso').on('submit', function(e){ e.preventDefault(); const list = read(STORAGE_KEYS.ingresos) || []; const data = { folio: $('#in_folio').val(), fecha: $('#in_fecha').val(), monto: $('#in_monto').val(), categoria: $('#in_categoria').val(), ref: $('#in_ref').val(), mes: $('#in_mes').val(), matricula: $('#in_matricula').val() }; const editIndex = $('#in_edit_index').val(); if (editIndex) { list[editIndex] = data; write(STORAGE_KEYS.ingresos, list); addAudit({ usuario: getCurrentUser().username, seccion: 'Ingreso', accion: 'Actualización', detalles: `Ingreso ${data.folio} actualizado` }); } else { list.unshift(data); write(STORAGE_KEYS.ingresos, list); addAudit({ usuario: getCurrentUser().username, seccion: 'Ingreso', accion: 'Creación', detalles: `Ingreso ${data.folio} creado` }); } $('#modalAgregarIngreso').modal('hide'); $('#formIngreso')[0].reset(); $('#in_edit_index').val(''); renderIngresosTable(); });
    $(document).on('click', '.btn-edit-in', function(){ const idx = $(this).data('idx'); const list = read(STORAGE_KEYS.ingresos)||[]; const e = list[idx]; $('#in_folio').val(e.folio); $('#in_fecha').val(e.fecha); $('#in_monto').val(e.monto); $('#in_categoria').val(e.categoria); $('#in_ref').val(e.ref); $('#in_mes').val(e.mes); $('#in_matricula').val(e.matricula); $('#in_edit_index').val(idx); $('#modalAgregarIngreso').modal('show'); });
    $(document).on('click', '.btn-del-in', function(){ const idx = $(this).data('idx'); if(!confirm('Eliminar ingreso?')) return; let list = read(STORAGE_KEYS.ingresos)||[]; const removed = list.splice(idx,1); write(STORAGE_KEYS.ingresos, list); addAudit({ usuario: getCurrentUser().username, seccion: 'Ingreso', accion: 'Eliminación', detalles: `Ingreso ${removed[0].folio} eliminado` }); renderIngresosTable(); });

    /* ------- Categorias CRUD ------- */
    $('#formCategoria').on('submit', function(e){ e.preventDefault(); const list = read(STORAGE_KEYS.categorias)||[]; const data = { nombre: $('#cat_nombre').val(), tipo: $('#cat_tipo').val(), descripcion: $('#cat_desc').val() }; const editIndex = $('#cat_edit_index').val(); if (editIndex) { list[editIndex] = data; write(STORAGE_KEYS.categorias, list); addAudit({ usuario: getCurrentUser().username, seccion: 'Categoria', accion: 'Actualización', detalles: `Categoría ${data.nombre} actualizada` }); } else { list.push(data); write(STORAGE_KEYS.categorias, list); addAudit({ usuario: getCurrentUser().username, seccion: 'Categoria', accion: 'Creación', detalles: `Categoría ${data.nombre} creada` }); } $('#modalAgregarCategoria').modal('hide'); $('#formCategoria')[0].reset(); $('#cat_edit_index').val(''); renderCategoriasTable(); refreshCategorySelects(); });
    $(document).on('click', '.btn-edit-cat', function(){ const idx = $(this).data('idx'); const list = read(STORAGE_KEYS.categorias)||[]; const c = list[idx]; $('#cat_nombre').val(c.nombre); $('#cat_tipo').val(c.tipo); $('#cat_desc').val(c.descripcion); $('#cat_edit_index').val(idx); $('#modalAgregarCategoria').modal('show'); });
    $(document).on('click', '.btn-del-cat', function(){ const idx = $(this).data('idx'); if(!confirm('Eliminar categoría? Esto afectará formularios que la usen.')) return; let list = read(STORAGE_KEYS.categorias)||[]; const removed = list.splice(idx,1); write(STORAGE_KEYS.categorias, list); addAudit({ usuario: getCurrentUser().username, seccion: 'Categoria', accion: 'Eliminación', detalles: `Categoría ${removed[0].nombre} eliminada` }); renderCategoriasTable(); refreshCategorySelects(); });

    /* ------- Presupuestos CRUD ------- */
    $('#formPresupuesto').on('submit', function(e){ e.preventDefault(); const list = read(STORAGE_KEYS.presupuestos)||[]; const data = { categoria: $('#pres_categoria').val(), monto: $('#pres_monto').val(), fecha: $('#pres_fecha').val() }; const editIndex = $('#pres_edit_index').val(); if (editIndex) { list[editIndex] = data; write(STORAGE_KEYS.presupuestos, list); addAudit({ usuario: getCurrentUser().username, seccion: 'Presupuesto', accion: 'Actualización', detalles: `Presupuesto ${data.categoria} actualizado` }); } else { list.push(data); write(STORAGE_KEYS.presupuestos, list); addAudit({ usuario: getCurrentUser().username, seccion: 'Presupuesto', accion: 'Creación', detalles: `Presupuesto ${data.categoria} creado` }); } $('#modalAgregarPresupuesto').modal('hide'); $('#formPresupuesto')[0].reset(); $('#pres_edit_index').val(''); renderPresupuestosTable(); });
    $(document).on('click', '.btn-edit-pres', function(){ const idx = $(this).data('idx'); const list = read(STORAGE_KEYS.presupuestos)||[]; const p = list[idx]; $('#pres_categoria').val(p.categoria); $('#pres_monto').val(p.monto); $('#pres_fecha').val(p.fecha); $('#pres_edit_index').val(idx); $('#modalAgregarPresupuesto').modal('show'); });
    $(document).on('click', '.btn-del-pres', function(){ const idx = $(this).data('idx'); if(!confirm('Eliminar presupuesto?')) return; let list = read(STORAGE_KEYS.presupuestos)||[]; const removed = list.splice(idx,1); write(STORAGE_KEYS.presupuestos, list); addAudit({ usuario: getCurrentUser().username, seccion: 'Presupuesto', accion: 'Eliminación', detalles: `Presupuesto ${removed[0].categoria} eliminado` }); renderPresupuestosTable(); });

    /* ------- Auditoría filtros ------- */
    $(document).on('submit', '#formFiltrosAuditoria', function(e){ e.preventDefault(); const f = { seccion: $('#f_seccion').val(), usuario: $('#f_usuario').val(), inicio: $('#f_inicio').val(), fin: $('#f_fin').val() }; renderAuditoriaTables(f); });

    /* ------- Reporte CSV generation ------- */
    $('#formReporte').on('submit', function(e){ e.preventDefault(); const seccion = $('#rep_seccion').val(); const categoria = $('#rep_categoria').val(); const inicio = $('#rep_fecha_inicio').val(); const fin = $('#rep_fecha_fin').val(); const usuario = $('#rep_usuario').val(); // collect relevant data
        let rows = [];
        if (!seccion || seccion === 'Egreso') { const eg = read(STORAGE_KEYS.egresos)||[]; rows = rows.concat(eg.map(r=> ({seccion:'Egreso', fecha:r.fecha, referencia:r.folio, usuario:getCurrentUser().username, categoria:r.categoria, monto:r.monto}))); }
        if (!seccion || seccion === 'Ingreso') { const ig = read(STORAGE_KEYS.ingresos)||[]; rows = rows.concat(ig.map(r=> ({seccion:'Ingreso', fecha:r.fecha, referencia:r.folio, usuario:getCurrentUser().username, categoria:r.categoria, monto:r.monto}))); }
        if (!seccion || seccion === 'Categoria') { const cats = read(STORAGE_KEYS.categorias)||[]; rows = rows.concat(cats.map(r=> ({seccion:'Categoria', fecha:'-', referencia:r.nombre, usuario:'-', categoria:r.tipo, monto:'-'}))); }
        if (!seccion || seccion === 'Presupuesto') { const ps = read(STORAGE_KEYS.presupuestos)||[]; rows = rows.concat(ps.map(r=> ({seccion:'Presupuesto', fecha:r.fecha, referencia:r.categoria, usuario:'-', categoria:'', monto:r.monto}))); }
        // filters
        if (categoria) rows = rows.filter(r=> r.categoria === categoria || r.referencia === categoria);
        if (inicio) rows = rows.filter(r=> r.fecha === '-' ? true : (new Date(r.fecha) >= new Date(inicio)));
        if (fin) rows = rows.filter(r=> r.fecha === '-' ? true : (new Date(r.fecha) <= new Date(fin)));
        if (usuario) rows = rows.filter(r=> r.usuario === usuario);
        if (rows.length === 0) { alert('No hay datos con esos filtros'); return; }
        const csv = [Object.keys(rows[0]).join(',')].concat(rows.map(r=> Object.values(r).map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(','))).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `reporte_${(new Date()).toISOString()}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    /* ------- Action menu clicks ------- */
    $(document).on('click', '#sidebar .nav-link', function(e){ e.preventDefault(); const module = $(this).data('module'); if (module) loadModule(module); });
    $(document).on('click', '#action-menu-container button', function(){ if (!$(this).attr('data-bs-toggle')) { $('#action-menu-container button').removeClass('active'); $(this).addClass('active'); const action = $(this).data('action'); const module = $('#sidebar .nav-link.active').data('module'); if (action) { if (action.includes('reportes-')) { $('#modalReporte').modal('show'); } else if (action.includes('historial-')) { loadModule(module); } } } });

    /* ------- Initial setup ------- */
    $(document).ready(function(){ refreshCategorySelects(); refreshUserOptions(); loadModule('mi-perfil');
        // populate selects when modals open
        $('#modalAgregarEgreso, #modalAgregarIngreso, #modalAgregarCategoria, #modalAgregarPresupuesto, #modalReporte').on('show.bs.modal', function(){ refreshCategorySelects(); refreshUserOptions(); });
    });

    /* ------- Auditoria render helpers call after CRUDs ------- */
    // After every write above we call addAudit and table rendering functions when relevant.

    /* ------- Logout ------- */
    $('#logoutLink').on('click', function(e){ e.preventDefault(); if(confirm('¿Cerrar sesión?')){ localStorage.removeItem(STORAGE_KEYS.currentUser); alert('Sesión cerrada (simulada). Se lo redirigirá a login.html'); window.location.href = 'login.html'; } });

    </script>
</body>
</html>
